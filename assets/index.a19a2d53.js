import{e,y as t,r as o,D as s,E as l,G as n,H as a,o as c,f as r,s as i,I as d,J as f,g as u,t as m,v as p,z as x,A as g,K as y,L as h,k as _,F as v,n as w,q as I}from"./vendor.10860888.js";import{u as b,i as H,a as P,b as T,c as $,d as L,e as N,f as C,g as R,h as W,j as E}from"./10.255707db.js";import"./index.cf28c33e.js";var M=e({name:"item",props:{index:{type:Number,required:!0},completed:{type:Boolean,default:()=>!1}},setup(e,{emit:c}){const r=a(F),i=t((()=>e.index<=r.currentProcessIndex));o(0);const{offsetTop:d,offsetLeft:f}=r,u=o(d),m=o(f),p=t((()=>({top:u.value+"px",left:m.value+"px"})));s((()=>p),((t,o)=>{console.log("需要重绘"),c("re-process",e.index)})),l((()=>{}));n((()=>{}));const x=o();return s((()=>e.completed),((t,o)=>{t&&t!==o&&c("process-next-item",(()=>new Promise(((t,o)=>{console.log(`${e.index} 渲染完成，继续渲染下一个`),t([e.index,x.value])}))))})),{itemStyle:p,test:()=>{alert(1)},waterfallInfo:r,isCompeleted:i,itemRef:x}}});var j={item:"_item_rex53_2"};(M.__cssModules={}).$style=j,M.render=function(e,t){return e.isCompeleted?(c(),r("div",{key:0,ref:"itemRef",class:e.$style.item,style:e.itemStyle},[i(e.$slots,"default")],6)):d("",!0)};var A=e({name:"box",props:{good:{type:Object,required:!0},index:{type:Number,required:!0}},setup:(e,{emit:t})=>({good:f(e).good,loadComplete:()=>{t("load-completed",e.index)}})});var k={box:"_box_16tyf_2",info:"_info_16tyf_10",pic:"_pic_16tyf_17",shade:"_shade_16tyf_1",title:"_title_16tyf_34",price:"_price_16tyf_46"};(A.__cssModules={}).$style=k,A.render=function(e,t,o,s,l,n){return c(),r("div",{class:e.$style.box},[u("div",{class:e.$style.info},[u("div",{class:e.$style.pic},[u("img",{src:e.good.src,onLoad:t[1]||(t[1]=(...t)=>e.loadComplete&&e.loadComplete(...t)),style:{height:"auto"}},null,40,["src"])],2),u("div",{class:e.$style.title},[u("a",null,[u("div",null,[u("strong",{class:e.$style.price},m(e.good.uuid),3)]),u("div",null,[u("em",null,m(e.good.name),1)])])],2)],2)],2)};const q=[H,P,T,$,L,N,C,R,W,E],F="WATERFALL_INFO_KEY";var B=e({name:"waterfall-flow",components:{Item:M,Box:A},setup(){const e=o(),t=o([]);y();const l=Math.floor(document.documentElement.clientWidth/300),a=p({boxWidth:300,colsNum:l,viewWidth:300*l,colHeights:new Array(l).fill(0),currentProcessIndex:0,offsetTop:0,offsetLeft:0});h(F,a);const c=o([]),r=o([]);s((()=>r),(()=>{const e=c.value[c.value.length-1];c.value=[e+1,e+2,e+3,e+4]}));const i=()=>new Promise(((e,t)=>{setTimeout((()=>{const t=new Array(10).fill(0).map(((e,t)=>{const o=Date.now()+t+"";return{uuid:o,name:o,title:`商品${o}`,src:q[t],href:"https://www.baidu.com",price:18*Math.random()}}));e(t)}),800)})),d=(e=[])=>{r.value=r.value.concat(e)};function f(){var t,o;return document.documentElement.clientHeight+(document.documentElement.scrollTop||document.body.scrollTop)>=(o=e.value,(t=o.children)[t.length-1].offsetTop+t[t.length-1].offsetHeight)}n((()=>{setTimeout((()=>{}),1e3)}));const{Throttle:u}=b();x((()=>{g((()=>{!async function(){const e=await i();d(e)}(),window.onscroll=(new u).use((async function(){if(console.log("onscroll"),f()){const e=await i();d(e)}}),800)}))}));const m=p([]);return{containerRef:e,itemsRef:t,waterfallInfo:a,processNextItem:async e=>{const[t,o]=await e(),{offsetLeft:s,offsetTop:l,offsetWidth:n,offsetHeight:c}=o,r=t%a.colsNum,i=(d=a.colHeights,Math.min.apply(null,d));var d;const f=((e,t)=>t.findIndex((t=>t<=e)))(i,a.colHeights);t<a.colsNum-1?(a.offsetLeft=r*a.boxWidth+o.offsetWidth,a.offsetTop=a.offsetTop,a.colHeights[r]=a.colHeights[f]):(a.colHeights[r]=c,a.offsetLeft=r*a.boxWidth,a.offsetTop=i+o.offsetHeight,a.colHeights[r]=a.colHeights[r]+c),a.currentProcessIndex+=1,console.log("process:",a.currentProcessIndex)},reProcess:e=>{console.log(e)},goods:r,status:m,loadCompleted:e=>{m[e]=!0}}}});(B.__cssModules={}).$style={"waterfall-flow":"_waterfall-flow_n46vt_2"},B.render=function(e,t){const o=_("box"),s=_("item");return c(),r("div",{ref:"containerRef",class:e.$style["waterfall-flow"]},[(c(!0),r(v,null,w(e.goods,((t,l)=>(c(),r(v,{key:t.uuid},[e.waterfallInfo.currentProcessIndex>=l?(c(),r(s,{key:0,ref:"itemsRef",index:l,completed:e.status[l],onProcessNextItem:e.processNextItem,onReProcess:e.reProcess},{default:I((()=>[u(o,{good:t,onLoadCompleted:e.loadCompleted,index:l},null,8,["good","onLoadCompleted","index"])])),_:2},1032,["index","completed","onProcessNextItem","onReProcess"])):d("",!0)],64)))),128))],2)};export default B;export{F as WATERFALL_INFO_KEY};
